{% extends 'base.html' %}

{% block content %}
<!-- Main container with proper sizing -->
<div class="bg-gray-500" style="height: 100vh; padding-top: 64px; padding-bottom: 140px; overflow: hidden;">
    <div class="max-w-6xl mx-auto p-4" style="height: 100%;">
        <!-- Chat Interface Container -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-400 flex flex-col" style="height: 75vh;">
            <!-- Chat Messages Area -->
            <div class="flex-1 overflow-y-auto p-4" id="chat-messages" style="max-height: 100%; overflow-x: hidden;">
                <!-- Chat Container for all conversations -->
                <div class="max-w-4xl mx-auto space-y-4">
                    <!-- Initial response if exists -->
                    {% if response %}
                    <!-- User Request Container - Left aligned -->
                    <div class="flex justify-start">
                        <div class="bg-gray-50 rounded-2xl p-4 shadow-sm border border-gray-100" style="max-width: 70%; word-wrap: break-word;">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-bold text-gray-900 mb-2">User request</div>
                                    <div class="text-gray-700 leading-relaxed text-sm" style="word-break: break-word; overflow-wrap: break-word;">{{ request.POST.user_message|default:"Tell me about Paris..." }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Response - Right aligned with margin -->
                    <div class="flex justify-end">
                        <div class="bg-gray-50 rounded-2xl p-4 shadow-sm border border-gray-100" style="max-width: 70%; max-height: 25vh; overflow-y: auto; word-wrap: break-word; margin-right: 0; margin-left: 15%;">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 mb-2">AI Travel Assistant</div>
                                    <div class="text-gray-700 leading-relaxed text-sm" style="word-break: break-word; overflow-wrap: break-word;">{{ response }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Welcome message when no conversation exists -->
                    <div class="flex justify-center items-center" style="min-height: 200px;">
                        <div class="text-center text-gray-500">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">AI Travel Guidance</h3>
                            <p class="text-gray-600">Ask me anything about travel destinations, tips, or planning your next adventure!</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
    
    <!-- Bottom Input Container - Fixed to bottom with centered content -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; padding: 1rem;" x-data="{ userMessage: '' }">
        <div style="max-width: 1000px; margin: 0 auto; border-radius: 1rem; overflow: hidden;">
            <form method="post" 
                  hx-post="{% url 'travel-guidance' %}"
                  hx-target="#chat-messages .max-w-4xl"
                  hx-swap="beforeend"
                  hx-on::after-request="
                    if(event.detail.successful) { 
                        userMessage = ''; 
                        $refs.textarea.style.height = '56px';
                        // Scroll to bottom after AI response is added
                        setTimeout(() => {
                            const chatMessagesContainer = document.querySelector('#chat-messages');
                            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                        }, 100);
                    }
                  "
                  hx-on::before-request="
                    const userMsg = userMessage.trim();
                    if (userMsg) {
                        const chatContainer = document.querySelector('#chat-messages .max-w-4xl');
                        const userRequestHtml = `
                            <div class='flex justify-start'>
                                <div class='bg-gray-50 rounded-2xl p-4 shadow-sm border border-gray-100' style='max-width: 70%; word-wrap: break-word;'>
                                    <div class='flex items-start space-x-3'>
                                        <div class='flex-shrink-0 w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center'>
                                            <svg class='w-4 h-4 text-white' fill='currentColor' viewBox='0 0 20 20'>
                                                <path d='M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z'/>
                                            </svg>
                                        </div>
                                        <div class='flex-1 min-w-0'>
                                            <div class='text-sm font-bold text-gray-900 mb-2'>User request</div>
                                            <div class='text-gray-700 leading-relaxed text-sm' style='word-break: break-word; overflow-wrap: break-word;'>${userMsg}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        chatContainer.insertAdjacentHTML('beforeend', userRequestHtml);
                        // Scroll the chat messages container, not the whole page
                        const chatMessagesContainer = document.querySelector('#chat-messages');
                        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                    }
                  "
                  style="display: flex; width: 100%;">
                {% csrf_token %}
                
                <!-- Input Field Container with Button Inside -->
                <div style="position: relative; width: 100%;">
                    <textarea 
                        name="user_message"
                        x-model="userMessage"
                        placeholder="Ask me about travel destinations..."
                        class="w-full px-6 py-4 text-lg font-medium rounded-3xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500 bg-white hover:border-gray-400 transition-all duration-200 shadow-sm placeholder-gray-500 resize-none"
                        required
                        rows="1"
                        x-ref="textarea"
                        @input="
                            $refs.textarea.style.height = 'auto';
                            $refs.textarea.style.height = Math.min($refs.textarea.scrollHeight, 150) + 'px';
                        "
                        @keydown.enter.prevent="
                            if (!$event.shiftKey && userMessage.trim()) {
                                $el.closest('form').requestSubmit();
                            } else if ($event.shiftKey) {
                                $refs.textarea.style.height = 'auto';
                                $refs.textarea.style.height = Math.min($refs.textarea.scrollHeight, 150) + 'px';
                            }
                        "
                        style="padding-left: 60px; padding-right: 60px; min-height: 56px; max-height: 150px; font-size: 16px; width: 100%; line-height: 1.5; overflow-y: auto;"
                    ></textarea>
                    
                    <!-- Arrow Submit Button - Inside the input field -->
                    <button 
                        type="submit"
                        class="absolute hover:bg-blue-700 disabled:opacity-30 transition-all duration-200 flex items-center justify-center"
                        :disabled="!userMessage.trim()"
                        :class="{ 'cursor-not-allowed': !userMessage.trim() }"
                        style="right: 10px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; min-width: 40px; min-height: 40px; background: #3b82f6; border: none; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center;"
                    >
                        <svg style="width: 16px; height: 16px; margin-left: 1px;" fill="white" stroke="none" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
